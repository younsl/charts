# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a Helm charts repository that distributes charts via OCI artifacts on GitHub Container Registry (ghcr.io). The repository contains production-ready Helm charts for Kubernetes deployments.

## Available Charts

### Active Charts
- **argo-workflows-templates** (v0.2.0): WorkflowTemplate and ClusterWorkflowTemplate resources for Argo Workflows
- **karpenter-nodepool** (v1.5.1): AWS Karpenter NodePool and EC2NodeClass resources for autoscaling with overprovisioning support
- **kube-green-sleepinfos** (v0.1.1): SleepInfo resources for kube-green to schedule resource hibernation
- **rbac** (v0.4.0): Kubernetes RBAC resources (ServiceAccount, ClusterRole, ClusterRoleBinding, Role, RoleBinding) with CI tests enabled
- **squid** (v0.7.0): Squid caching proxy with Grafana dashboard integration and extra manifests support

## Common Development Commands

### Documentation
```bash
# Generate documentation for all charts using shared template
make docs

# Generate docs for specific chart (uses .github/templates/README.md.gotmpl template)
helm-docs --chart-search-root charts/<chart-name> --template-files=../../.github/templates/README.md.gotmpl --sort-values-order file --log-level info
```

### Linting and Validation
```bash
# Lint a specific chart
helm lint charts/<chart-name>

# Template a chart to validate rendering
helm template <release-name> charts/<chart-name>

# Dry-run installation to validate against cluster
helm install <release-name> charts/<chart-name> --dry-run --debug
```

### Testing
```bash
# Run local tests with Kind cluster
kind create cluster
helm install test-release charts/<chart-name>
helm test test-release

# Test with specific CI values (if chart has ci/test-values.yaml)
helm install test-release charts/<chart-name> -f charts/<chart-name>/ci/test-values.yaml

# Use CI script for comprehensive testing (mimics GitHub Actions)
CHARTS_TO_TEST='["<chart-name>"]' KUBERNETES_VERSION="1.34.0" .github/scripts/test-charts.sh
```

### Chart Discovery and Registry Operations
```bash
# List available chart versions in registry
crane ls ghcr.io/younsl/charts/<chart-name>

# Show chart information
helm show chart oci://ghcr.io/younsl/charts/<chart-name>
helm show values oci://ghcr.io/younsl/charts/<chart-name>

# Package a chart
helm package charts/<chart-name>

# Push to OCI registry (requires authentication)
helm push <chart-name>-<version>.tgz oci://ghcr.io/younsl/charts
```

### Installing Charts
```bash
# Install from OCI registry
helm install <release-name> oci://ghcr.io/younsl/charts/<chart-name> --version <version>

# Install with custom values
helm install <release-name> oci://ghcr.io/younsl/charts/<chart-name> \
  --version <version> \
  --values custom-values.yaml
```

### CI/CD Operations
```bash
# Detect changed charts (like CI does)
.github/scripts/detect-changed-charts.sh

# Run chart release process
.github/scripts/release-charts.sh
```

## Architecture and Structure

### Directory Layout
- `charts/`: Contains all Helm charts, each in its own directory
- `.github/workflows/`: CI/CD pipelines for automated testing and releases
- `.github/scripts/`: Automation scripts for testing, releasing, and documentation
- `.github/templates/`: Shared templates for documentation generation (helm-docs)
- `docs/`: Repository documentation including OCI background
- Each chart follows standard Helm structure:
  - `Chart.yaml`: Chart metadata and dependencies
  - `values.yaml`: Default configuration values
  - `templates/`: Kubernetes resource templates
  - `ci/`: Test values for CI testing (multiple test scenarios supported)
  - `README.md`: Chart-specific documentation (auto-generated by helm-docs)

### CI/CD Pipeline
The repository uses GitHub Actions for:
1. **Release Process**: Triggered by Chart.yaml changes or manual dispatch
   - Multi-version testing on Kubernetes 1.32.8, 1.33.4, 1.34.0
   - Packages and pushes charts to OCI registry (ghcr.io/younsl/charts)
   - Smart change detection via `.github/scripts/detect-changed-charts.sh`
   - Version duplicate checking against OCI registry
   - GitHub Actions step summaries for release tracking
   - Atomic installations with automatic rollback on failure

2. **Documentation**:
   - Auto-generates README files using helm-docs
   - Uses shared gotmpl template (.github/templates/README.md.gotmpl) for consistent documentation

3. **Maintenance**:
   - Automated workflow run cleanup (daily at 1 AM UTC)

### Chart Development Guidelines
- All charts require Helm 3.8.0+ and Kubernetes 1.21.0+
- Charts are distributed via OCI registry, not traditional Helm repositories
- Each chart includes comprehensive values documentation
- Test values are provided in `ci/` directory for validation
- Charts follow semantic versioning
- CI uses Helm v3.18.0 and yq v4.48.1 for processing

## Key Technical Details

### OCI Registry Usage
Charts are published to `ghcr.io/younsl/charts` as OCI artifacts. This provides:
- Better security with container registry authentication
- Improved performance with parallel layer downloads
- Integration with existing container workflows
- Version duplicate prevention via registry queries

### Testing Strategy
- Unit tests: Template rendering validation
- Integration tests: Installation in Kind clusters with custom API server tuning
- CI tests: Automated validation on push to main
- Charts with full CI tests enabled: `rbac` (other charts require external dependencies)

### Chart Testing and CI Behavior
Charts can control CI testing behavior using annotations in Chart.yaml:
```yaml
annotations:
  "helm.sh/skip-test": "true"
  "helm.sh/skip-test-reason": "Requires external dependencies"
```

The CI testing process:
1. Detects changed charts via git diff on Chart.yaml files
2. Runs `helm lint` validation
3. Creates Kind cluster with custom configuration (API server performance tuning)
4. Performs dry-run validation
5. Discovers and runs all test files matching `charts/<chart-name>/ci/*.yaml`
6. Installs chart using discovered test values
7. Runs `helm test` if test resources exist and skip-test is false
8. Captures comprehensive logs and results
9. Cleans up test resources

### Special Considerations
- **argo-workflows-templates**: Requires Argo Workflows controller, creates WorkflowTemplate and ClusterWorkflowTemplate resources
- **karpenter-nodepool**: AWS-specific, requires Karpenter controller, includes overprovisioning with dummy deployments
- **kube-green-sleepinfos**: Requires kube-green operator
- **rbac**: Chart with full CI testing enabled (skip-test: false), supports extra-manifests for additional resources
- **squid**: Includes Grafana dashboard ConfigMap and extra-manifests.yaml template for additional resources


## Best Practice References

When developing or improving charts in this repository, use the following repositories as best practice references:
- **Bitnami Charts** (https://github.com/bitnami/charts): Industry-standard patterns for chart structure, templating, and documentation
- **Delivery Hero Helm Charts** (https://github.com/deliveryhero/helm-charts): Production-grade examples of complex chart implementations and CI/CD workflows

Study these repositories for guidance on:
- Chart templating patterns and helper functions
- Values schema design and validation
- Testing strategies and CI pipelines
- Documentation standards and README structure
- Security best practices and RBAC patterns

## Development Workflow

When working with this repository:
1. Always validate charts with `helm lint` before committing
2. Update chart version in Chart.yaml when making changes
3. Run `make docs` after modifying chart values or templates
4. Test installation with dry-run before actual deployment
5. Use OCI registry commands for distribution, not traditional repo commands
6. CI will automatically test on Kubernetes 1.32.8, 1.33.4, 1.34.0
7. Check for version duplicates in OCI registry before releasing

## Troubleshooting

### Common Issues
- **Chart testing fails**: Check if chart has skip-test annotation or requires external dependencies
- **Documentation not updating**: Ensure `make docs` was run and .github/templates/README.md.gotmpl template is correct
- **Release pipeline fails**: Verify Chart.yaml version bump and OCI registry authentication
- **Version already exists**: Chart version already published to OCI registry, bump version in Chart.yaml

### Debugging Commands
```bash
# Test specific chart locally like CI does
CHARTS_TO_TEST='["chart-name"]' KUBERNETES_VERSION="1.34.0" .github/scripts/test-charts.sh

# Check what changes CI would detect
.github/scripts/detect-changed-charts.sh

# Verify chart can be packaged
helm package charts/<chart-name> --destination /tmp

# Check if version exists in registry
crane ls ghcr.io/younsl/charts/<chart-name> | grep <version>
```

## Repository Maintenance

### Automated Processes
- **Workflow cleanup**: Runs daily at 1 AM UTC to clean old workflow runs

### Manual Maintenance
- **Chart deprecation**: Update Chart.yaml with deprecated: true and update documentation
- **Version updates**: Bump version in Chart.yaml following semantic versioning
- **Registry cleanup**: Use crane or docker CLI to manage OCI artifacts if needed