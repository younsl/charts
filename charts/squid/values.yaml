# Default values for squid.
# This is a YAML-formatted file.
# -- (string) Override the name of the chart
nameOverride: ""
# -- (string) Override the fullname of the chart
fullnameOverride: ""

# -- (int) Number of squid replicas to deploy
replicaCount: 2
# -- (int) Number of old ReplicaSets to retain for rollback
revisionHistoryLimit: 10

strategy:
  # -- (string) Deployment strategy type
  type: RollingUpdate
  rollingUpdate:
    # -- (string) Maximum number of pods that can be created above the desired number of pods during the update
    # Can be an absolute number (ex: 5) or a percentage of desired pods (ex: 10%)
    maxSurge: 25%
    # -- (string) Maximum number of pods that can be unavailable during the update
    # Can be an absolute number (ex: 5) or a percentage of desired pods (ex: 10%)
    maxUnavailable: 25%

# -- (object) Container image configuration
# @default -- See below values
image:
  # -- (string) Container image repository
  repository: ubuntu/squid
  # -- (string) Container image tag
  tag: "6.13-25.04_beta"
  # -- (string) Image pull policy
  pullPolicy: IfNotPresent

# -- (list) Image pull secrets for private registries
imagePullSecrets: []
  # - name: my-registry-secret
  # - name: my-registry-secret-2

# -- (object) Common labels to add to all kubernetes resources (will be merged with resource-specific labels)
commonLabels: {}
  # team: platform
  # environment: production
  # cost-center: engineering

# -- (object) Common annotations to add to all kubernetes resources (will be merged with resource-specific annotations)
commonAnnotations:
  description: Squid is a HTTP/HTTPS proxy server supporting caching and domain whitelist access control.

# -- (object) A resource-specific annotations for Deployment
annotations: {}

serviceAccount:
  # -- (bool) Specifies whether a service account should be created
  create: true
  # -- (string) The name of the service account to use.
  # If not set, defaults to a name generated using the fullname template
  name: ""
  # -- (bool) Set to false for better security unless your application needs to access Kubernetes API
  automountServiceAccountToken: false
  # -- (object) Annotations to add to the service account
  annotations: {}
    # eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/squid-proxy-role
  # -- (list) Image pull secrets to attach to the service account
  imagePullSecrets: []
    # - name: my-registry-secret
    # - name: another-registry-secret

# -- (object) Annotations to add to the pod
podAnnotations: {}
  ## Example pod annotations for Prometheus metrics scraping
  # prometheus.io/scrape: "true"
  # prometheus.io/port: "9301"
  # prometheus.io/path: "/metrics"

# -- (object) Pod security context configuration
podSecurityContext:
  # -- (int) FSGroup that owns the pod's volumes
  fsGroup: 13

# -- (int) Grace period for pod termination (should be longer than squid shutdown_lifetime)
terminationGracePeriodSeconds: 60
# -- (int) Squid shutdown timeout (used in shutdown_lifetime and preStop hook timing)
squidShutdownTimeout: 30

# -- (object) Security context for the container
# @default -- See below values
securityContext:
  # -- (object) Linux capabilities to drop or add
  capabilities:
    drop:
    - ALL
  # -- (bool) Whether to mount the root filesystem as read-only
  readOnlyRootFilesystem: false
  # -- (bool) Set to true to run as non-root user
  runAsNonRoot: true
  # -- (int) User 'proxy' is pre-defined in squid container image
  runAsUser: 13
  # -- (int) Group 'proxy' is pre-defined in squid container image
  runAsGroup: 13

# -- (list) Environment variables for squid container
env: []
  # - name: HTTP_PROXY
  #   value: "http://proxy.example.com:3128"
  # - name: DEBUG_LEVEL
  #   value: "2"
  # - name: SQUID_CONFIG_PATH
  #   value: "/etc/squid/squid.conf"

# -- (list) Environment variables from existing ConfigMaps and Secrets for squid container
envFrom: []
  # - configMapRef:
  #     name: squid-env-config
  # - secretRef:
  #     name: squid-env-secret

# -- (string) DNS policy for the pod
dnsPolicy: ClusterFirst
# -- (object) DNS configuration for the pod
dnsConfig: {}
  # nameservers:
  #   - 1.1.1.1
  #   - 8.8.8.8
  # searches:
  #   - ns1.svc.cluster-domain.example
  #   - my.dns.search.suffix
  # options:
  #   - name: ndots
  #     value: "2"
  #   - name: edns0

# -- (object) Kubernetes service configuration
# @default -- See below values
service:
  # -- (string) Available service types: ClusterIP, NodePort, LoadBalancer
  type: ClusterIP
  # -- (int) Squid normally listens to port 3128, but you can change it to any port you want
  port: 3128
  # -- (int) Squid normally listens to port 3128, but you can change it to any port you want
  targetPort: 3128
  # -- (string) Dedicated node port for NodePort service
  nodePort: ""
  # -- (string) External traffic policy for LoadBalancer and NodePort services
  externalTrafficPolicy: ""
  # -- (string) Load balancer IP address
  loadBalancerIP: ""
  # -- (list) Load balancer source IP ranges
  loadBalancerSourceRanges: []
  # -- (string) Controls how traffic is distributed across the service endpoints
  # Optional field - if not set, Kubernetes uses default load balancing (random distribution)
  # Available values: PreferClose (topology-aware routing), null (disabled)
  trafficDistribution: ""
  # -- (object) A resource-specific annotations for Service
  annotations: {}
    ## Example annotations for AWS Load Balancer Controller
    # service.beta.kubernetes.io/aws-load-balancer-name: custom-name
    # service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
    # service.beta.kubernetes.io/aws-load-balancer-scheme: internal
    # service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "false"
    # service.beta.kubernetes.io/aws-load-balancer-security-groups: sg-<FIXME>
    # service.beta.kubernetes.io/aws-load-balancer-subnets: subnet-<FIXME>,subnet-<FIXME>
    # service.beta.kubernetes.io/aws-load-balancer-additional-resource-tags: Environment=dev,Team=platform
    ## Example annotations for MetalLB
    # metallb.universe.tf/address-pool: production-public-ips
    ## Example annotations for kubernetes TAR(Topology Aware Routing) feature
    ## See: https://kubernetes.io/docs/concepts/services-networking/topology-aware-routing/
    # service.kubernetes.io/topology-mode: Auto

# -- Ingress configuration for external access to squid proxy
# @default -- See below values
ingress:
  # -- (bool) Enable or disable Ingress resource creation
  enabled: false
  # -- (string) IngressClass name to use for this Ingress
  className: ""
  # -- (object) A resource-specific annotations for Ingress
  annotations: {}
    # kubernetes.io/ingress.class annotations was deprecated from 1.18, and removed in 1.22.
    # Before the IngressClass resource and ingressClassName field were added in Kubernetes 1.18,
    # Ingress classes were specified with a kubernetes.io/ingress.class annotation on the Ingress.
    # See: https://kubernetes.io/docs/concepts/services-networking/ingress/#deprecated-annotation
    # kubernetes.io/ingress.class: nginx
  # -- (list) List of hostnames and paths for Ingress routing
  hosts:
    - host: squid.local
      paths:
        - path: /
          pathType: Prefix
  # -- (list) TLS configuration for HTTPS termination
  tls: []

# -- (object) Resource limits and requests for squid container
# @default -- See below values
resources:
  # -- (object) Maximum resource limits (CPU and memory)
  limits:
    memory: 256Mi
  # -- (object) Minimum resource requests (CPU and memory)
  requests:
    cpu: 50m
    memory: 128Mi

# -- (list) Container resize policy for in-place resource updates
# See: https://kubernetes.io/docs/tasks/configure-pod-container/resize-container-resources/
resizePolicy: []
  # - resourceName: cpu
  #   restartPolicy: NotRequired
  # - resourceName: memory
  #   restartPolicy: RestartContainer

# -- (object) Node selector for pod assignment
nodeSelector: {}

# -- (list) Tolerations for pod assignment
tolerations: []

# -- (object) Affinity rules for pod assignment
affinity: {}

# -- (list) Pod topology spread constraints (modern approach for pod distribution)
topologySpreadConstraints: []
  ## Example: Spread squid pods evenly across nodes
  # - maxSkew: 1
  #   topologyKey: kubernetes.io/hostname
  #   whenUnsatisfiable: DoNotSchedule  # or ScheduleAnyway
  #   labelSelector:
  #     matchLabels:
  #       app.kubernetes.io/name: squid
  ## Example: Spread squid pods evenly across multi AZ
  # - maxSkew: 1
  #   topologyKey: topology.kubernetes.io/zone
  #   whenUnsatisfiable: DoNotSchedule
  #   labelSelector:
  #     matchLabels:
  #       app.kubernetes.io/name: squid
  #   minDomains: 2

# -- (object) Squid configuration
config:
  # -- (object) Allowed networks configuration
  allowedNetworks:
    # -- (list) Additional networks that can access the proxy
    extra: []
      # - name: "office"
      #   cidr: "203.0.113.0/24"
      #   description: "office network"
      # - name: "branch"
      #   cidr: "198.51.100.0/24"
      #   description: "branch office"
      # - name: "custom"
      #   cidr: "1.2.3.0/24"
      #   description: "custom network"

  # -- (string) Squid configuration file content
  # This configuration will be mounted to /etc/squid/squid.conf inside the squid container
  # See: https://www.squid-cache.org/Versions/v6/cfgman/
  # @default -- Default squid.conf with basic ACLs and security settings. See [values.yaml](https://github.com/younsl/younsl.github.io/blob/main/content/charts/squid/values.yaml) for full configuration.
  squid.conf: |
    ## Squid normally listens to port {{ .Values.service.targetPort | default 3128 }}
    http_port {{ .Values.service.targetPort | default 3128 }}

    ## PID file location (writable by proxy user)
    pid_filename /var/spool/squid/squid.pid

    ## Log rotation setting
    logfile_rotate 0

    ## Reduce log verbosity for health checks
    debug_options ALL,1
    
    ## Uncomment and adjust the following to add a disk cache directory.
    # cache_dir ufs /var/spool/squid 100 16 256
    
    ## To disable caching completely, uncomment the following line:
    # cache deny all
    
    ## Leave coredumps in the first cache dir
    coredump_dir /var/spool/squid
    
    ## =============================================================================
    ## TIMEOUT CONFIGURATION
    ## =============================================================================
    ## Connection timeouts
    connect_timeout 10 seconds          # Timeout for server connections
    read_timeout 15 minutes             # Timeout for reading from servers
    request_timeout 1 minutes           # Timeout for client requests
    client_lifetime 1 day               # Maximum time a client connection is kept alive
    
    ## Persistent connection timeouts
    pconn_timeout 1 minute              # Timeout for persistent connections to servers
    half_closed_clients off             # Don't wait for clients to close connections
    
    ## Shutdown timeout
    shutdown_lifetime {{ .Values.squidShutdownTimeout }} seconds
        
    ## Add any of your own refresh_pattern entries above these.
    refresh_pattern ^ftp:           1440    20%     10080
    refresh_pattern ^gopher:        1440    0%      1440
    refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
    refresh_pattern .               0       20%     4320
    
    ## =============================================================================
    ## SECURITY CONFIGURATION
    ## =============================================================================
    ## Port security ACLs and rules
    acl SSL_ports port 443 563
    acl Safe_ports port 80 21 443 70 210 1025-65535 280 488 591 777
    acl CONNECT method CONNECT
    
    ## Security rules (processed first)
    http_access deny !Safe_ports
    http_access deny CONNECT !SSL_ports
    
    ## =============================================================================
    ## NETWORK ACCESS CONTROL
    ## =============================================================================
    ## Allowed networks definition
    acl allowed_nets src 10.0.0.0/8
    acl allowed_nets src 172.16.0.0/12
    acl allowed_nets src 192.168.0.0/16
    acl allowed_nets src fc00::/7
    acl allowed_nets src fe80::/10
    acl allowed_nets src 127.0.0.1
    acl allowed_nets src localhost

    ## Additional allowed networks
    {{- if .Values.config.allowedNetworks.extra }}
    {{- range $network := .Values.config.allowedNetworks.extra }}
    acl allowed_nets src {{ $network.cidr }}  # {{ $network.description }}
    {{- end }}
    {{- end }}
    
    ## =============================================================================
    ## DOMAIN FILTERING (OPTIONAL)
    ## =============================================================================
    ## Domain whitelist definition (uncomment to enable domain filtering)
    # acl allowed_domains dstdomain .example.com
    # acl allowed_domains dstdomain .google.com
    # acl allowed_domains dstdomain .github.com
    # acl allowed_domains dstdomain .kubernetes.io
    
    ## =============================================================================
    ## ACCESS RULES
    ## =============================================================================
    ## Option 1: Allow all domains for trusted networks (default)
    http_access allow allowed_nets
    
    ## Option 2: Domain filtering (uncomment below and comment above)
    ## Step 1: Uncomment domain ACLs above
    ## Step 2: Comment out "http_access allow allowed_nets" above  
    ## Step 3: Uncomment the line below
    # http_access allow allowed_nets allowed_domains

    ## Cache Manager access control (allow localhost and pod-internal access)
    http_access allow localhost manager
    http_access deny manager
    
    ## Deny everything else
    http_access deny all

  # -- (object) A resource-specific annotations for ConfigMap
  annotations: {}

# -- (object) Horizontal Pod Autoscaler
# See: https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/
# @default -- See below values
autoscaling:
  # -- (bool) Enable or disable horizontal pod autoscaling
  enabled: false
  # -- (int) Minimum number of replicas
  minReplicas: 2
  # -- (int) Maximum number of replicas
  maxReplicas: 10
  # -- (int) Target CPU utilization percentage for autoscaling
  targetCPUUtilizationPercentage: 70
  # targetMemoryUtilizationPercentage: 80
  # -- (object) A resource-specific annotations for HorizontalPodAutoscaler
  annotations: {}
  # -- (object) Autoscaling behavior configuration
  # See: https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#configurable-scaling-behavior
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 600
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
      - type: Pods
        value: 2
        periodSeconds: 60
      selectPolicy: Min

# -- (object) Liveness probe determines if the container is running properly
# If it fails, Kubernetes will restart the container
# @default -- See below values
livenessProbe:
  # -- (bool) Enable or disable the liveness probe
  enabled: true
  # -- (int) Delay before the first probe is initiated after container starts (seconds)
  # Give Squid enough time to initialize before checking
  initialDelaySeconds: 20
  # -- (int) How often to perform the probe (seconds)
  # More frequent checks = faster failure detection but higher overhead
  periodSeconds: 5
  # -- (int) Number of seconds after which the probe times out (seconds)
  # Should be less than periodSeconds
  timeoutSeconds: 1
  # -- (int) Minimum consecutive successes for the probe to be considered successful after having failed
  # Lower values mean faster recovery detection
  successThreshold: 1
  # -- (int) Number of consecutive failures before restarting the container
  # Higher values prevent restarts during temporary network issues
  failureThreshold: 3

# -- (object) Readiness probe determines if the container is ready to receive traffic
# If it fails, the pod is removed from service endpoints but not restarted
# @default -- See below values
readinessProbe:
  # -- (bool) Enable or disable the readiness probe
  enabled: true
  # -- (int) Delay before the first probe is initiated after container starts (seconds)
  # Can be lower than liveness probe since we want to detect readiness quickly
  initialDelaySeconds: 5
  # -- (int) How often to perform the probe (seconds)
  # Frequent checks ensure traffic is only sent to ready pods
  periodSeconds: 5
  # -- (int) Number of seconds after which the probe times out (seconds)
  # Keep it short for quick detection
  timeoutSeconds: 1
  # -- (int) Minimum consecutive successes for the probe to be considered successful after having failed
  # Set to 1 for quick recovery
  successThreshold: 1
  # -- (int) Number of consecutive failures before marking the pod as not ready
  # Pod stays alive but doesn't receive traffic
  failureThreshold: 3

# -- (object) Persistence for cache
# @default -- See below values
persistence:
  # -- (bool) Enable or disable persistent volume for cache
  enabled: false
  # -- (string) Storage class name for the persistent volume
  storageClassName: ""
  # -- (string) Access mode for the persistent volume
  accessMode: ReadWriteOnce
  # -- (string) Size of the persistent volume
  size: 1Gi
  # -- (string) Name of an existing persistent volume to use
  volumeName: ""
  # -- (object) A resource-specific annotations for PersistentVolumeClaim
  annotations: {}

# -- (object) Pod Disruption Budget
# @default -- See below values
podDisruptionBudget:
  # -- (bool) Enable or disable pod disruption budget
  enabled: true
  # -- (int) Use minAvailable or maxUnavailable, not both
  # If both are set, minAvailable takes priority
  minAvailable: 1
  # maxUnavailable: 1
  # -- (object) A resource-specific annotations for PodDisruptionBudget
  annotations: {}
  # -- (string) unhealthyPodEvictionPolicy controls when unhealthy pods are evicted
  # Valid values: IfHealthyBudget (default), AlwaysAllow
  # IfHealthyBudget: Unhealthy pods can be disrupted only if minimum available pods are met
  # AlwaysAllow: Always allow eviction of unhealthy pods (best effort availability)
  unhealthyPodEvictionPolicy: IfHealthyBudget

# -- (object) Squid Exporter for Prometheus metrics
# See: https://github.com/boynux/squid-exporter
# @default -- See below values
squidExporter:
  # -- (bool) Enable or disable squid exporter sidecar
  enabled: true
  # -- (object) Container image configuration for squid exporter
  # @default -- See below values
  image:
    # -- (string) Container image repository
    repository: boynux/squid-exporter
    # -- (string) Container image tag
    tag: "v1.13.0"
    # -- (string) Image pull policy
    pullPolicy: IfNotPresent
  # -- (int) Port for exposing metrics
  port: 9301
  # -- (string) Metrics endpoint path
  metricsPath: /metrics
  # -- (object) Resource limits and requests for squid exporter container
  resources:
    limits:
      memory: 64Mi
    requests:
      cpu: 10m
      memory: 32Mi
  # -- (list) Container resize policy for in-place resource updates
  # See: https://kubernetes.io/docs/tasks/configure-pod-container/resize-container-resources/
  resizePolicy: []
    # - resourceName: cpu
    #   restartPolicy: NotRequired
    # - resourceName: memory
    #   restartPolicy: RestartContainer
  # -- (string) Squid hostname to connect to
  squidHostname: localhost
  # -- (int) If not specified squidPort, defaults to .Values.service.targetPort
  squidPort: ~
  # -- (string) Authentication username (if squid requires basic auth)
  squidLogin: ""
  # -- (string) Authentication password (if squid requires basic auth)
  squidPassword: ""
  # -- (bool) Extract service times from squid
  extractServiceTimes: true
  # -- (object) Additional custom labels for prometheus metrics by squid-exporter
  # By default, customLabels values are passed to squid-exporter as command line arguments (e.g. "-label=environment=development -label=cluster=dev")
  customLabels: {}
    # environment: development
    # cluster: krdev
    # team: platform

# -- (object) Squid grafana dashboard provided by squid-exporter
# @default -- See below values
dashboard:
  # -- (bool) Whether to create squid grafana dashboard configmap
  enabled: false
  # -- (string) Namespace where grafana is installed
  # Dashboard configmap need to be in the same namespace as grafana
  grafanaNamespace: ""
  # -- (object) A resource-specific annotations for ConfigMap
  annotations: {}

# -- (list) Extra manifests to deploy additional Kubernetes resources
# Supports tpl function for dynamic values
extraManifests: []
  # - apiVersion: v1
  #   kind: ConfigMap
  #   metadata:
  #     name: '{{ include "squid.fullname" . }}-extra'
  #     namespace: '{{ .Release.Namespace }}'
  #   data:
  #     key: value
  # - |
  #   apiVersion: v1
  #   kind: Secret
  #   metadata:
  #     name: {{ include "squid.fullname" . }}-secret
  #   stringData:
  #     password: {{ .Values.squidExporter.squidPassword | quote }}
