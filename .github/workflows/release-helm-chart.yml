name: Release Helm Charts
run-name: 📦 Release Helm Charts to ghcr.io

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**/Chart.yaml'
  workflow_dispatch:
    inputs:
      chart:
        description: 'Specific chart to release (leave empty for all)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  CHARTS_DIR: ./charts

jobs:
  detect-changes:
    name: Detect Changed Charts
    runs-on: ubuntu-24.04
    outputs:
      charts: ${{ steps.detect.outputs.charts }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Detect changed charts
        id: detect
        env:
          INPUT_CHART: ${{ github.event.inputs.chart }}
        run: |
          chmod +x .github/scripts/detect-changed-charts.sh
          .github/scripts/detect-changed-charts.sh

  test:
    name: Test Charts on K8s ${{ matrix.kubernetes-version }}
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        kubernetes-version: [1.31.9, 1.32.5, 1.33.2]
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.18.0
      
      - name: Install yq
        uses: mikefarah/yq@v4.47.1

      - name: Lint Charts
        env:
          CHARTS_TO_LINT: ${{ needs.detect-changes.outputs.charts }}
        run: |
          # Parse charts from JSON array and lint each one
          readarray -t charts < <(echo "${CHARTS_TO_LINT}" | jq -r '.[]')
          
          for chart in "${charts[@]}"; do
            echo "🔍 Linting chart: ${chart}"
            helm lint "charts/${chart}"
          done

      - name: Create kind config
        run: |
          cat << EOF > /tmp/kind-config.yaml
          ---
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            kubeadmConfigPatches:
            - |
              kind: ClusterConfiguration
              apiServer:
                extraArgs:
                  max-requests-inflight: "1000"
                  max-mutating-requests-inflight: "500"
          EOF

      - name: Setup Kind cluster
        uses: helm/kind-action@v1.12.0
        with:
          cluster_name: kind
          version: v0.20.0
          node_image: kindest/node:v${{ matrix.kubernetes-version }}
          config: /tmp/kind-config.yaml

      - name: Test All Changed Charts
        env:
          CHARTS_TO_TEST: ${{ needs.detect-changes.outputs.charts }}
          KUBERNETES_VERSION: ${{ matrix.kubernetes-version }}
        run: |
          chmod +x .github/scripts/test-charts.sh
          .github/scripts/test-charts.sh

  release:
    name: Release Charts to OCI Registry
    needs: [detect-changes, test]
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.18.0
      
      - name: Install yq
        uses: mikefarah/yq@v4.47.1

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Release All Changed Charts
        env:
          CHARTS_TO_RELEASE: ${{ needs.detect-changes.outputs.charts }}
        run: |
          chmod +x .github/scripts/release-charts.sh
          .github/scripts/release-charts.sh
